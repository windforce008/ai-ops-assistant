# -*- coding: utf-8 -*-
# ai_ops_nuclear_v1.py  â€”â€”  ç¬¬1å‘¨æ ¸å¼¹åˆä½“ç‰ˆï¼ˆ45å²è¿ç»´è€å…µäº²æµ‹ï¼‰
# åŠŸèƒ½ï¼šCPUé«˜/æ—¥å¿—ERROR â†’ é€šä¹‰åƒé—®è¯Šæ–­ â†’ ä¼ä¸šå¾®ä¿¡@æ‰€æœ‰äºº

import psutil
import time
import requests
import json
from datetime import datetime
from pathlib import Path
from dashscope import Generation

# ========= ä½ åªéœ€è¦æ”¹ä¸‹é¢è¿™ä¸‰è¡Œ =========
QIANWEN_API_KEY = "sk-ä½ çš„é˜¿é‡Œåƒé—®APIKEY"   # é€šä¹‰åƒé—®API Keyï¼ˆå…è´¹é¢†ï¼‰
WECHAT_WEBHOOK   = "ä½ çš„å¾®ä¿¡webhook"  # ç¾¤æœºå™¨äºº
LOG_ROOT = Path("D:/logs")           # æ—¥å¿—æ ¹ç›®å½•
# ========================================
import os
os.environ['DASHSCOPE_API_KEY']=QIANWEN_API_KEY
Generation.api_key = QIANWEN_API_KEY
last_alert_time = 0          # é˜²æ­¢1åˆ†é’Ÿåˆ·å±
scanned_files = set()        # è®°å½•å·²æ‰«æè¿‡çš„æ–‡ä»¶ï¼Œé¿å…é‡å¤å‘Šè­¦

def ask_qwen(prompt: str) -> str:
    try:
        resp = Generation.call(model='qwen-turbo', prompt=prompt)
        if resp.status_code == 200:
            return resp.output['text'].strip()
        return "å¤§æ¨¡å‹è°ƒç”¨å¤±è´¥"
    except Exception as e:
        return f"å¤§æ¨¡å‹å¼‚å¸¸ï¼š{e}"

def push_wechat_md(title: str, content: str = "", mention_all: bool = False):
    data = {
        "msgtype": "markdown",
        "markdown": {
            "content": f"{title}\n{content}\n> <font color='red'>è‡ªåŠ¨å‘Šè­¦</font> {datetime.now():%Y-%m-%d %H:%M:%S}"
        }
    }
    if mention_all:
        data["markdown"]["content"] = "@æ‰€æœ‰äºº\n" + data["markdown"]["content"]
    
    try:
        r = requests.post(WECHAT_WEBHOOK, json=data, timeout=10)
        if r.json().get("errcode") != 0:
            print("æ¨é€å¤±è´¥ï¼š", r.text)
    except Exception as e:
        print("ç½‘ç»œå¼‚å¸¸ï¼š", e)

def check_cpu():
    global last_alert_time
    cpu = psutil.cpu_percent(interval=1)
    if cpu > 80 and time.time() - last_alert_time > 300:  # 5åˆ†é’Ÿåªå‘ä¸€æ¬¡
        prompt = f"æœåŠ¡å™¨CPUçªç„¶é£™åˆ°{cpu}%ï¼Œä½œä¸º10å¹´è¿ç»´è€å…µï¼Œæœ€å¯èƒ½çš„3ä¸ªåŸå› å’Œè§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæ¯æ¡ä¸è¶…è¿‡30å­—ã€‚"
        answer = ask_qwen(prompt)
        msg = f"### ğŸš¨ CPUé«˜è´Ÿè½½å‘Šè­¦\nå½“å‰CPUï¼š{cpu}%\n\n**AIè¯Šæ–­ï¼š**\n{answer}"
        push_wechat_md("CPUå‘Šè­¦", msg, mention_all=True)
        last_alert_time = time.time()

def scan_logs():
    global last_alert_time
    if not LOG_ROOT.exists():
        return
    
    for log_file in LOG_ROOT.rglob("*.log"):
        if log_file not in scanned_files and log_file.stat().st_size > 0:
            try:
                with log_file.open('r', encoding='utf-8', errors='ignore') as f:
                    new_lines = [line for line in f if any(kw in line.upper() for kw in ["ERROR","FAIL","EXCEPTION","FATAL"])]
                if new_lines and time.time() - last_alert_time > 300:
                    sample = "\n".join(new_lines[-5:])  # æœ€å5è¡Œ
                    prompt = f"æ—¥å¿—å‘ç°ä¸¥é‡é”™è¯¯ï¼Œè¯·åˆ†æå¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼ˆä¸­æ–‡ï¼Œç®€æ´3æ¡ï¼‰ï¼š\n{sample}"
                    answer = ask_qwen(prompt)
                    msg = f"### æ—¥å¿—ä¸¥é‡å¼‚å¸¸\næ–‡ä»¶ï¼š{log_file}\n\næœ€æ–°é”™è¯¯ï¼š\n{sample}\n\n**AIè¯Šæ–­ï¼š**\n{answer}"
                    push_wechat_md("æ—¥å¿—å‘Šè­¦", msg, mention_all=True)
                    last_alert_time = time.time()
            except:
                continue
        scanned_files.add(log_file)

print("æ ¸å¼¹å·²å¯åŠ¨ï¼AIè¿ç»´åˆ†èº«æ­£å¼ä¸Šçº¿ï¼ï¼ˆCtrl+Cåœæ­¢ï¼‰")
print(f"ç›‘æ§ç›®å½•ï¼š{LOG_ROOT}   |   ä¼ä¸šå¾®ä¿¡ç¾¤å·²ç»‘å®š")

while True:
    check_cpu()
    scan_logs()
    time.sleep(10)   # ä¸»å¾ªç¯10ç§’ä¸€æ¬¡
